<html>
    <head>
        <title>Transplant Visualization</title>
        <style type="text/css">
        body {
        font: 8pt helvetica neue;
        color: #666;
        }
        td {
        font: 8pt helvetica neue;
        color: #666;
        }
        input {
        font: 8pt helvetica neue;
        }
        .chr_range {
            font: 10pt;
        }
        .outlined {
            color: #666;
            border-color: #F5F5F5;
            border-width: 2px 2px 2px 2px;
            border-style: solid;
            border-spacing: 0px;

            }
    </style>
        <link rel="stylesheet" type="text/css" href="/addama/ui/ext-js-3.3.0/resources/css/ext-all.css">
        <script type="text/javascript" language="javascript" src="/addama/ui/prototype.js"></script>
        <script type="text/javascript" src="http://www.google.com/jsapi"></script>
        <script type="text/javascript">
 google.load("prototype", "1.6.1.0");
 google.load('visualization','1', {packages:['table']});
</script>
<script type="text/javascript" src="/addama/ui/protovis-1.0/protovis-r3.3.1.js"></script>
<script type="text/javascript" src="/addama/ui/protovis-1.0/visdata.js"></script>
<script type="text/javascript" src="/addama/ui/protovis-1.0/google-ds-utils.js"></script>
<script type="text/javascript" src="/addama/systemsbiology.org/applications/circvis/js/utilities.js"></script>

<script type="text/javascript" src="/addama/systemsbiology.org/applications/circvis/js/data_retrieval.js"></script>
<script type="text/javascript" src="/addama/systemsbiology.org/applications/circvis/js/circvis.js"></script>

        <script type="text/javascript" src="/addama/ui/ext-js-3.3.0/adapter/ext/ext-base.js"></script>
        <script type="text/javascript" src="/addama/ui/ext-js-3.3.0/ext-all.js"></script>
         <script type="text/javascript" src="/addama/ui/ext-js-3.3.0/examples/shared/examples.js"></script>
        <script type="text/javascript" src="/addama/ui/ext-js-3.3.0/examples/ux/ux-all.js"></script>
        <script type="text/javascript" src="/js/topbar.js"></script>
        <script type="text/javascript" src="/addama/ui/refgenome/refgenome.js"></script>
       <script type="text/javascript" language="javascript" src="/addama/ui/flexscroll/flexscroll.js"></script>
         <script type="text/javascript" src="./js/chromosomeRangeControl.js"></script>
            <script type="text/javascript" src="./js/transplantVisualization.js"></script>
    <script type="text/javascript" src="./js/transplant.js"></script>
        <script type="text/javascript" src="./js/patientSelectorControl.js"></script>
             <script type="text/javascript">
                Ext.BLANK_IMAGE_URL = '/addama/ui/ext-js-3.3.0/resources/images/default/s.gif';
            </script>
           <script type="text/javascript" src="/addama/systemsbiology.org/applications/circvis/js/wedge_plot.js"></script>
        
        <script type="text/javascript">
            var centertabs = null;
            var email = "";
            var topBarPanel = null;
            var topMenuPanel = null;
            var currentRange = null;
            var currentDataset = null;
            var currentPatients = null;
            var dataSetChangeListeners = new Array();
            var patientSelector = null;
            var visualizationControl = null;
            var transplantParameters;
            var selectedChromRangeUri;
            var chromosomeRangeLoaded = false;
            var workspacesLoaded=false;
            var rangeControl=null;
            var westPanel = null;
            var viewPort = null;
            var loadMask = null;
            var workspaceUri = "/addama/repositories/workspaces/informatics@systemsbiology.org/ov_gbm_dataset";

            var tick_listener = function(chr,start,stop,label){
                if(chr.indexOf("OV") > -1){
                    chr=chr.substring(2,chr.length);
                    datasettype="OV";
                }
                else if(chr.indexOf("GBM") > -1){
                    chr=chr.substring(3,chr.length);
                    datasettype="GBM";
                }
                else {
                    datasettype="None";
                }
                
                onRangeSelection(chr,start,stop,label);
                onDatasetChange(datasettype);
            };

             Ext.onReady(function(){
                 Ext.QuickTips.init();
                 new TopBar().initialize("container_north", {});

                 topBarPanel = new Ext.Panel({
                     contentEl: $("container_north")

                 });

                 currentRange =  new Ext.FormPanel({
                     title: 'Current Selections',
                     labelAlign: 'top',
                     frame: true,
                     height: 220,
                     padding: '5',
                     items:[{
                         layout:'column',
                         items:[{
                             columnWidth: 0.95,
                             layout:'form',
                             items:[{
                                 xtype:'textfield',
                                 fieldLabel:'Chr',
                                 id:'currentrange_chr',
                                 width: 30,
                                 readOnly:true
                             },
                                     {
                                 xtype:'textfield',
                                 fieldLabel:'Range',
                                 id:'currentrange_range',
                                 fieldClass:'chr_range',
                                         width: 150,
                                 readOnly:true
                             },
                                     {
                                 xtype:'textfield',
                                 fieldLabel:'Gene',
                                 id:'currentrange_gene',
                                 width: 80,
                                 readOnly:true
                             }]
                             }]
                     }]
                     });

                 geneSearchPanel = new Ext.FormPanel({
                     labelAlign: 'top',
                     title: 'Gene Select',
                     height : 120,
                     frame: true,
                     padding: '5',
                     //defaultType : 'textfield',
                     items:[{
                            layout:'column',
                            items:[{
                                columnWidth: 0.8,
                                layout:'form',
                                items:[{
                                    xtype:'textfield',
                                    fieldLabel: 'Gene Symbol',
                                    name:'gene_symbol',
                                    id:'gene_symbol',
                                    anchor:'95%',
                                    allowBlank:false
                                }]
                            }]
                     }],
                     buttons: [{
                         text:'Select',
                         listeners:{
                             click: function(){ onGeneSelection(Ext.getCmp('gene_symbol').getValue())}
                         }
                     }]

                 });
                 
                 rangeControl = new ChromosomeRangeControl("container_rangeControl","/addama/refgenome/hg18","chr22",0,51304566,29576000,750000);

                 rangeControl.addSelectionListener(this);

                    onRangeSelection('22',29576000,29576000+750000);


                 circvis_ov = new Ext.Panel({
                                    contentEl: $("chromovis_ov_div"),
                                    autoScroll: true,
                                    anchor: '100%'
                                 });

                                  circvis_gbm = new Ext.Panel({
                                    contentEl: $("chromovis_gbm_div"),
                                    autoScroll: true,
                                    anchor: '100%'
                                 });

                                  circvis_ov_gbm = new Ext.Panel({
                                    contentEl: $("chromovis_ov_gbm_div"),
                                    autoScroll: true,
                                    anchor: '100%'
                                 });


                 var comparatorButton = new Ext.Button({
                      id: 'comparatorButton',
                      text: 'Table View',
                      handler: onItemToggle

                 });

                 comparatorPanel = new Ext.form.FormPanel({
                     title: 'Cancer Comparator',
                     id: 'comparator-panel',
                     padding: '5 5 5 5',
                     items: [comparatorButton,circvis_ov_gbm],
                     autoScroll: true,
                     tools: [{
                         id: 'help',
                         handler: function(event, toolEl, panel){
                             //
                         }
                     }]
                 });

                  ovPanel = new Ext.Panel({
                     title: 'OV Gene Disruption',
                     id: 'ov-panel',
                     padding: '5 5 5 5',
                     items: [circvis_ov],
                     autoScroll: true,
                     tools: [{
                         id: 'help',
                         handler: function(event, toolEl, panel){
                             //
                         }
                         
                     }]
                 });

                  gbmPanel = new Ext.Panel({
                     title: 'GBM Gene Disruption',
                     id: 'gbm-panel',
                     padding: '5 5 5 5',
                     items: [circvis_gbm],
                     autoScroll: true,
                                           tools: [{
                         id: 'help',
                         handler: function(event, toolEl, panel){
                             //
                         }

                     }]
                 });

                 visualizationControlPanel = new Ext.Panel({
                     autoScroll: true,
                     contentEl: $('container_visualization'),
                     flex: 15
                 });

                 visHeaderControlPanel = new Ext.Panel({
                     contentEl: $("container_visheader"),
                     autoScroll: false,
                     flex: 1
                 });


                 chromSelectionPanel = new Ext.Panel({
                    title: 'Chromosome Range',

                     layout: 'fit',
                    items: [],
                     height: 100,
                     width:750


                 });

                 patientSelectionPanel = new Ext.Panel({
                    title: 'Patients',
                     layout: 'fit',
                     height: 400,
                     width:750
                 });

                 visualizationCenter = new Ext.Panel({
                     region: 'center',
                     collapsible: false,
                     layout: {
                         type: 'vbox',
                         padding: '5',
                         align: 'stretch'
                     },
                     items: [visHeaderControlPanel,visualizationControlPanel],
                     autoScroll: true
                 });



                 dataSelectionPanel = new Ext.Window({
                      title: 'Data Selection',
                        id: 'dataselection-window',
                    autoWidth : true,
                     autoHeight : true,
                     modal: true,
                     closeAction : 'hide',

                     items:[chromSelectionPanel,patientSelectionPanel],
                         listeners : {
                              hide: function() {
                                  visualizationControl.loadVisualizationForSelectedPatients();
                              }
                          }
                 });

                 showSelectionPanel = function() {
                             dataSelectionPanel.show();
                 };

                 visPanelToolbar = new Ext.Toolbar({
                                    items: [{
                                        text: 'Data and Range Selection',
                                        handler: showSelectionPanel
                                    },{
                                        text: 'Advanced Parameters',
                                        handler: function() {loadVisualizationParameters();}
                                    }
                                    ]
                                });

                 visualizationPanel = new Ext.Panel({
                       title: 'Fastbreak',
                       id: 'fastbreak-panel',
                       layout: 'border',
                     tbar : visPanelToolbar,
                       defaults: {
                           bodyStyle: 'padding:15px',
                           animFloat: false,
                           floatable: false

                       },
                       items: [visualizationCenter],
                                          tools: [{
                         id: 'help',
                         handler: function(event, toolEl, panel){
                             //
                         }

                     }]
                 });



                 centerPanel = new Ext.Panel({
                     id: 'center-panel',
                    layout:'card',
                    region: 'center',
                     border:false,
                     closable:false,
                     activeItem:0,
                     height: 800,
                     margins: '0 5 5 0',
                    items:[{
                        id:'homepage-panel',
                        layout: 'fit',
                        html:'This is the homepage!',
                        title: 'Home'
                    },comparatorPanel,ovPanel,gbmPanel,visualizationPanel]


                });

                  navigationPanel =  new Ext.tree.TreePanel({
                     title: 'Navigation',
                     rootVisible: false,
                     lines: false,
                     singleExpand: true,
                     useArrows: true,
                     //flex:10,
                      height : 180,
                     padding: '5',
                      margin: '5',
                     autoScroll: true,
                        loader: new Ext.tree.TreeLoader(),
                    root: new Ext.tree.AsyncTreeNode({
                        expanded: true,
                        children: [{
                            text: 'Home Page',
                            leaf: true,
                            id: 'homepage'
                         }, {
                            text: 'Cancer Comparator',
                            leaf: true,
                            id: 'comparator'
                        },{
                            text: 'Gene Disruption',
                            leaf: false,
                            id: 'genedisruption',
                            children: [{
                                text: 'OV',
                                leaf: true,
                                id: 'ov'
                            },{
                                text: 'GBM',
                                leaf: true,
                                id: 'gbm'
                            }]
                        },{
                            text: 'Fastbreak',
                            leaf: true,
                            id: 'fastbreak'
                        }]
                     })
                 });

                 westPanel = new Ext.Panel({
                                region: 'west',
                                collapsible: true,
                                expanded: true,
                                //collapseMode:'mini',
                                width: 180,
                                layout: {
                                    type: 'vbox',
                                    padding: '5px,5px,5px,5px',
                                    align: 'stretch'
                                },
                     defaults : {
                         padding : '0px, 0px, 5px, 0px'
                     },
                                items: [currentRange,navigationPanel,geneSearchPanel]
                 });

                 navigationPanel.on('click', function(n){
    	var sn = this.selModel.selNode || {}; // selNode is null on initial selection
    	if(n.leaf && (  n.id+'-panel') != Ext.getCmp('center-panel').layout.activeItem){  // ignore clicks on folders and currently selected node
    		Ext.getCmp('center-panel').layout.setActiveItem(n.id + '-panel');
    		if(n.id == 'fastbreak'){
                                //$("container_visheader").innerHTML = "<p align=\"right\"><a href=\"#\" onClick=loadVisualizationParameters()>Advanced Parameters</a></p><div align='center' id='legenddiv'></div>";
                org.systemsbiology.visualization.transplant.colorkey(org.systemsbiology.visualization.transplant.chrmcolors.human,document.getElementById('legenddiv'));
  //                    visualizationControl.loadVisualizationForSelectedPatients();

            }
            else if(n.id == 'comparator'){
                onCircvisTypeSelected('ov_gbm');
            }
            else if(n.id == 'ov'){
                onCircvisTypeSelected('ov');
            }
            else if(n.id == 'gbm'){
                onCircvisTypeSelected('gbm');
            }
    	}
    });

                 new Ajax.Request("/addama/users/whoami", {
                    method: "get",
                    onSuccess: function(o) {
                        var json = o.responseJSON;
                        if (json && json.email) {
                            email = json.email;


                        } else {
                            showError("Authentication", "User is not logged in");
                        }
                    }
                });

                patientSelectorControl = new PatientSelectorControl(workspaceUri,onPatientSelectorLoaded,onPatientSelectionChange);
                visualizationControl = new TransplantVisualization("container_visualization","/addama/refgenome/hg18",workspaceUri +"/track.tsv",selectedChromRangeUri);
                transplantParameters = new TransplantParameters();
                transplantParameters.addListener(visualizationControl);

                loadPage();

      });

     function onItemToggle(item, pressed){
         if(item.text == 'Table View'){
                item.setText('Circvis View');
         }
         else
            item.setText('Table View');
                Ext.example.msg('Button Toggled', 'Button "{0}" was toggled to {1}.', item.text, pressed);
     }

    //function called when data load for circvis is complete
    function onLoadGBMDataComplete() {
        $('chromovis_gbm_div').innerHTML="";
        wedge_plot($('chromovis_gbm_div'));
          loadMask.hide();
        if(viewPort != null){
	        viewPort.doLayout();
	    }
    }

     function onLoadOVDataComplete() {
        $('chromovis_ov_div').innerHTML="";
        wedge_plot($('chromovis_ov_div'));
           loadMask.hide();
        if(viewPort != null){
	        viewPort.doLayout();
	    }
    }

    function onLoadOVGBMDataComplete() {
        $('chromovis_ov_gbm_div').innerHTML="";
        wedge_plot_ov_gbm($('chromovis_ov_gbm_div'));
                    loadMask.hide();
        if(viewPort != null){
	        viewPort.doLayout();
	    }
    }

    function onCircvisTypeSelected(circvisType){
        if(circvisType == 'ov_gbm' && $('chromovis_ov_gbm_div').innerHTML == ""){
            loadMask = new Ext.LoadMask(comparatorPanel.getEl(), {msg:"Loading Circvis..."});
            loadMask.show();
            loadDataOVGBM(onLoadOVGBMDataComplete,500,0);
        }
        else if(circvisType == 'gbm' && $('chromovis_gbm_div').innerHTML == ""){
            loadMask = new Ext.LoadMask(gbmPanel.getEl(), {msg:"Loading Circvis..."});
            loadMask.show();
            loadData(onLoadGBMDataComplete,circvisType,500,0);
        }
        else if(circvisType == 'ov' && $('chromovis_ov_div').innerHTML == ""){
            loadMask = new Ext.LoadMask(ovPanel.getEl(), {msg:"Loading Circvis..."});
            loadMask.show();
            loadData(onLoadOVDataComplete, circvisType,500,0);
        }


    }

    function onDatasetChange(datasettype){

        //TODO: should potentially sort by this datatype in patient selector....

    }

    function onPatientSelectionChange(patientItems){
        var patienthtml="<ul>Selected Patients";
           $A(patientItems).each(function(item){
               patienthtml = patienthtml + "<li>" + item.id + "</li>";
           });

        patienthtml = patienthtml + "</ul>";

        visualizationControl.onPatientSelection(patientItems);

    }

    function onPatientSelectorLoaded(){
        patientSelectionPanel.removeAll();
        patientSelectionPanel.add(patientSelectorControl.patientGrid);
    }




    function onRangeSelection(chrom,startpos,endpos,gene){
        Ext.getCmp('currentrange_chr').setValue(chrom);
        Ext.getCmp('currentrange_range').setValue(formatNumber(startpos) + "-" + formatNumber(endpos));
        if (gene == null || gene == "") {
            Ext.getCmp('currentrange_gene').setValue("");
        }
        else (Ext.getCmp('currentrange_gene').setValue(gene))
            if(viewPort != null)
                viewPort.doLayout();
        

        if(visualizationControl != null)  {
            var chromRangeUri = "chr"+chrom+"/" + startpos + "/" + endpos;
            visualizationControl.onRangeSelection(chromRangeUri);
        }

        selectedChromRangeUri = chromRangeUri;

    }

            function onGeneSelection(gene_symbol){
                if (gene_symbol.length < 1 || gene_symbol.length > 10) { return;}


                var network_query = new google.visualization.Query('/addama/systemsbiology.org/datasources/tcgajamboree/fastbreak/genes/query');
                network_query.setQuery('select chr, start, end where `gene_symbol` = \'' + gene_symbol.toUpperCase() +'\'' );
                function handleGeneQuery(response) {
                    var table = response.getDataTable();
                    var buffer = 20000;  //20Kbp window upstream and down
                    if(table.getNumberOfRows() == 1) {
                        var json_array = GoogleDSUtils.dataTableToArray(table);
                        var chrom = json_array[0]['chr'];
                        var startpos = json_array[0]['start'];
                        var endpos = json_array[0]['end'];

                       onRangeSelection(chrom,startpos-buffer < 0 ? 0 : startpos-buffer,endpos+buffer,gene_symbol);
                    } else {
                        showError("Gene Selection", "Gene symbol not found.");
                    }
                }


                network_query.send(handleGeneQuery);

            }

    function onChromosomeRangeLoaded(){
        chromosomeRangeLoaded=true;
        chromSelectionPanel.removeAll();
        chromSelectionPanel.add(rangeControl.radioPanel);
    }



    function loadPage( ){

     topPanel = new Ext.Panel({
        region: 'north',
         height: 26,
         items:[topBarPanel]
     });

    viewPort = new Ext.Viewport({
        layout: 'border',
        renderTo: Ext.getBody(),
        items: [    topPanel
        ,westPanel,centerPanel]
});


}
            function showError(title, msg) {
                Ext.MessageBox.show({
                   title: title,
                   msg: msg,
                   buttons: Ext.MessageBox.OK,
                   icon: Ext.MessageBox.ERROR
               });
            }

            function formatNumber(number) {
            number = '' + number;
            if (number.length > 3) {
            var mod = number.length % 3;
            var output = (mod > 0 ? (number.substring(0,mod)) : '');
            for (i=0 ; i < Math.floor(number.length / 3); i++) {
            if ((mod == 0) && (i == 0))
            output += number.substring(mod+ 3 * i, mod + 3 * i + 3);
            else
            output+= ',' + number.substring(mod + 3 * i, mod + 3 * i + 3);
            }
            return (output);
            }
            else return number;
            }

        function loadVisualizationParameters(){
            transplantParameters.show();
        }

        </script>
    </head>
    <body>
    <div id="container_top"></div>
            <div hidden='true' id="container_north"></div>
            <div align='center' class="x-hidden" id="container_rangeControl"></div>
            <div align='center'  id="container_visheader"></div>
            <div id="container_visualization" class="x-hide-display"></div>
            <div id="chromovis_ov_div"></div>
            <div id="chromovis_gbm_div"></div>
            <div id="chromovis_ov_gbm_div"></div>

    </body>
</html>
